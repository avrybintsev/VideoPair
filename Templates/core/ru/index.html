<!doctype html>

<html lang="en">
<head>
    <meta charset="utf-8">
    <title>VideoPair</title>
    <link href="{{ STATIC_URL }}css/bootstrap.min.css" rel="stylesheet">

    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <script src="{{ STATIC_URL }}js/jquery-1.11.1.min.js"></script>
    <script src="{{ STATIC_URL }}js/jquery.form.min.js"></script>
    <script src="{{ STATIC_URL }}js/bootstrap.min.js"></script>
    <script src="{{ STATIC_URL }}js/popcorn.min.js"></script>

    <style>
        body {
            padding-top: 70px;
            padding-bottom: 50px;
        }
        .container-login {
            max-width: 500px;
        }
        .form-signin {
            padding: 0;
            margin: 0 auto;
        }
        .form-signin .form-control {
            position: relative;
            height: auto;
            -webkit-box-sizing: border-box;
            -moz-box-sizing: border-box;
            box-sizing: border-box;
            padding: 10px;
            font-size: 16px;
        }
        .form-button-container {
            margin-top: 10px;
            text-align: center;
        }
        .finish-block {
            display: none;
        }
        .loader-block {
            display: block;
        }
        .question-block {
            display: none;
        }
        video {
            width: 100%    !important;
            height: auto   !important;
        }
        .header-line {
            border-bottom: 1px solid #eee;
        }
        .none-form {
            margin-top: 20px;
            text-align: center;
        }
        .progress-text {
            text-align: center;
        }
    </style>
</head>

<body>
<div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                {% if participant %}
                    <span class="icon-bar"></span>
                {% endif %}
            </button>
            <a class="navbar-brand" href="{% url 'core.views.index' lang %}">VideoPair</a>
        </div>
        <div class="collapse navbar-collapse">
            <ul class="nav navbar-nav">
                {% if participant %}
                    <li><a href="{% url 'core.views.invalidate' %}">Выйти ({{ participant }})</a></li>
                {% endif %}
                <li><a href="{% url 'core.views.index' 'en' %}">Сменить язык</a></li>
            </ul>
        </div>
    </div>
</div>

{% if not participant %}
    <div class="container container-login">
        <div class="login-panel panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title">Сравнение видеопоследовательностей</h3>
            </div>
            <div class="panel-body">
                <form class="form-signin" role="form" method="post" action="/new">
                    {% csrf_token %}
                    <fieldset>
                        <div class="form-group">
                            <input class="form-control" placeholder="E-mail" id="id_email" name="email" type="email"
                                   autofocus="">
                        </div>
                        <div class="form-group">
                            <input class="form-control" placeholder="Имя" id="id_name" name="name" type="name" value="">
                        </div>
                        <div class="form-button-container">
                            <button class="btn btn-lg btn-success" type="submit">Начать тестирование</button>
                        </div>
                    </fieldset>
                </form>
            </div>
        </div>
    </div>
{% else %}
    <div class="container">
        <div class="finish-block" id="finish-block">
            <p>{{ participant.name }}, вы ответили на все вопросы, спасибо!</p>
        </div>

        <div class="loader-block" id="loader-block">
            <div class="info-block">
                <p class="lead">VideoPair - сравнение видеопоследовательностей!</p>
                <p>
                    Немного информации.
                </p>
            </div>
            <div class="progress-block">
                <div class="progress-text">
                    Загрузка видео: <span id="progress-current">0</span> из <span id="progress-total">20</span>
                </div>
                <div class="progress">
                    <div id="progress" class="progress-bar" role="progressbar"
                         aria-valuenow="0" aria-valuemin="0" aria-valuemax="20" style="width: 0%;">
                    </div>
                </div>
            </div>
        </div>

        {% for form in forms %}
            <div class="question-block" id="question{{ forloop.counter0 }}">
                <div class="container">
                    <div class="header header-line">
                        <h3>Сравнение видеопоследовательностей</h3>
                        <p class="lead lead-smallmargin">Вопрос #<span id="counter{{ forloop.counter0 }}">{{ forloop.counter }}</span> из {{ forms|length }}</p>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <video id="player-video-left{{ forloop.counter0 }}" loop poster="{{ STATIC_URL }}poster.gif"></video>
                        </div>
                        <div class="col-md-6">
                            <video id="player-video-right{{ forloop.counter0 }}" loop poster="{{ STATIC_URL }}poster.gif"></video>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 clearfix">
                            <form method="post" action="/ans" id="form-left{{ forloop.counter0 }}">
                                {% csrf_token %}
                                {{ form.answer_left_form }}
                                <button id="best-left{{ forloop.counter0 }}" type="submit" class="btn btn-lg btn-primary pull-left">
                                    Левый вариант лучше
                                </button>
                            </form>
                        </div>
                        <div class="col-md-6 clearfix">
                            <form method="post" action="/ans" id="form-right{{ forloop.counter0 }}">
                                {% csrf_token %}
                                {{ form.answer_right_form }}
                                <button id="best-right{{ forloop.counter0 }}" type="submit" class="btn btn-lg btn-primary pull-right">
                                    Правый вариант лучше
                                </button>
                            </form>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12 none-form">
                            <form method="post" action="/ans" id="form-none{{ forloop.counter0 }}">
                                {% csrf_token %}
                                {{ form.answer_none_form }}
                                <button id="best-none{{ forloop.counter0 }}" type="submit" class="btn btn-lg btn-default">
                                    Не получается выбрать лучший вариант
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endfor %}

    <script>
        window.requestAnimFrame = function () {
            return (
                    window.requestAnimationFrame ||
                            window.webkitRequestAnimationFrame ||
                            window.mozRequestAnimationFrame ||
                            window.oRequestAnimationFrame ||
                            window.msRequestAnimationFrame ||
                            function (/* function */ callback) {
                                window.setTimeout(callback, 1000 / 60);
                            }
                    );
        }();

        var videos = [
                    {% for form in forms %}
                        {
                            left: Popcorn("#player-video-left{{ forloop.counter0 }}"),
                            right: Popcorn("#player-video-right{{ forloop.counter0 }}")
                        }
                        {% if not forloop.last %},{% endif %}
                    {% endfor %}
                ],

                videos_el = [
                    {% for form in forms %}
                        {
                            left: $("#player-video-left{{ forloop.counter0 }}")[0],
                            right: $("#player-video-right{{ forloop.counter0 }}")[0]
                        }
                        {% if not forloop.last %},{% endif %}
                    {% endfor %}
                ],

                progress_total = {{ forms|length }} * 2,
                progress_current = 0,
                controls = {
                    loader: $("#loader-block"),
                    finish: $("#finish-block"),
                    progress: $("#progress"),
                    progress_total: $("#progress-total"),
                    progress_current: $("#progress-current"),
                    questions: [
                        {% for form in forms %}
                            $("#question{{ forloop.counter0 }}"){% if not forloop.last %},{% endif %}
                        {% endfor %}
                    ]
                },

                progress = {},

                current = 0,

                total = {{ forms|length }};


            videos.forEach(function (video) {
                var event = "play";
                video.left.on(event, function () {
                    video.right[ event ]();
                });
            });

        update_progress = function() {
            var progress_percent = Math.round((progress_current / progress_total) * 100);
            controls.progress.attr("aria-valuemax", progress_total);
            controls.progress.attr("aria-valuenow", progress_current);
            controls.progress.css("width", progress_percent+"%");
            controls.progress_total.text(progress_total);
            controls.progress_current.text(progress_current);
        };

        load_video = function(element, mp4_path, webm_path) {
            var r = new XMLHttpRequest();
            r.onload = function() {
                element.src = URL.createObjectURL(r.response);
                //console.log("loaded!" + element.id);
            };
            if (element.canPlayType('video/mp4')) {
                r.open("GET", mp4_path);
            }
            else {
                r.open("GET", webm_path);
            }
            r.responseType = "blob";
            r.send();
        };

        videos.forEach(function (video) {
            Popcorn.forEach(video, function (media, type) {
                progress[media.id] = false;
                media.on("canplayall",function () {
                    //console.log("canplayall" + media.id);
                    progress[media.id] = true;
                    progress_current++;
                    update_progress();
                    if (Object.keys(progress).every(function(key){ return progress[key] })) {
                        //console.log("start playing!");
                        controls.loader.hide();

                        sync();
                        controls.questions[current].show();
                        videos[current].left.play();
                        //controls.preloader.hide();
                    }
                })
            });
        });

        function sync() {
            if ((current < total) && (videos[current].right.media.readyState === 4 )) {
                left_time = videos[current].left.currentTime();
                right_time = videos[current].right.currentTime();
                if (Math.abs(left_time - right_time) > 0.1) {
                    videos[current].right.currentTime(left_time)
                }
            }
            requestAnimFrame( sync );
        }

        next_question = function () {
            controls.questions[current].hide();
            current++;
            if (current < total) {
                controls.questions[current].show();
                videos[current].left.play();
                sync();
            } else {
                controls.finish.show();
            }
        };

        on_success = function (data) {
            var status_object = $.parseJSON(data);
            if (status_object.status == "ok") {
                console.log("ok");
                next_question();
            } else {
                console.log("error");
            }
        };

        {% for form in forms %}
            load_video(
                    videos_el[{{ forloop.counter0 }}].left,
                    "{{ video_path }}/{{ form.question.sequence.name }}/{{ form.question.left.short_name }}.mp4",
                    "{{ video_path }}/{{ form.question.sequence.name }}/{{ form.question.left.short_name }}.webm"
            );
            load_video(
                    videos_el[{{ forloop.counter0 }}].right,
                    "{{ video_path }}/{{ form.question.sequence.name }}/{{ form.question.right.short_name }}.mp4",
                    "{{ video_path }}/{{ form.question.sequence.name }}/{{ form.question.right.short_name }}.webm"
            );
            $("#form-left{{ forloop.counter0 }}").ajaxForm(
                    {
                        url: '/ans',
                        type: 'post',
                        success: on_success
                    });
            $("#form-right{{ forloop.counter0 }}").ajaxForm(
                    {
                        url: '/ans',
                        type: 'post',
                        success: on_success
                    });
            $("#form-none{{ forloop.counter0 }}").ajaxForm(
                    {
                        url: '/ans',
                        type: 'post',
                        success: on_success
                    });
        {% endfor %}

    </script>
{% endif %}

</body>
</html>